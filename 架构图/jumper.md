# 跳板机
## 背景
* 统一权限控制
* 线上机器单一入口
* 审计功能

## 现状
目前线上的机器都是在root下保存密钥，通过单跳板机直接登陆
## 新跳板机设计
### 简介
引入ldap权限认证体系，统一账号，每个需要登陆的用户有自己独立的账户，并且登陆服务器后，对该账户的所有操作进行记录。
跳板机到生产服务器到密钥需要二次加密，即使秘钥泄露，也无法直接通过该密钥登陆到服务器。

主要用到组件包括：freeipa,keychain,
* freeipa:开源的ldap系统，可以有多活配置
* keychain:秘钥密码管理工具，免除已认证用户重复输出密钥密码

### 网络设计
* 除了跳板机和指定的ldap机器，所有的机器流量需要通过ELB或者NAT网关出去，EC2不直接绑定IP地址
* 现有的带IP地址的机器，向AWS咨询有没有能删除IP的方案(AWS回复已经创建外网IP的实例是无法取消外IP地址的。 可以考虑重建)

## 流程
成员 | 角色
--------- | -------------
user |  运维 OR 开发
jumper01 | 1号跳板机 审计机 开放外网80,22,443端口
ldap | 集中权限认证中心 双主配置
jumper02 | 生产环境跳板机 对外没有开放访问 到生产环境密钥加密
```sequence
    user->jumper01:用户名密码登陆
    jumper01->ldap:认证
    ldap-->jumper01:认证通过
    jumper01->jumper01:home目录创建
    jumper01->jumper01:用户角色切换
    jumper01-->user:选择要登陆的跳板机
    user->jumper01:选择登陆
    jumper01->jumper02:登陆指定跳板机
    jumper02-->user:登陆完成
```
* 第一次用户登陆，跳板机会去ldap服务器获取登陆用户信息，并建立Home目录
* 根据跳板机决策脚本，在目标组的用户为worker角色，其余为rd角色


